name: 'AWS SSM Deploy'
description: 'Deploy to EC2 instance using AWS SSM with ECR image'

inputs:
  EC2:
    description: 'EC2 instance ID'
    required: true
  SERVICE_NAME:
    description: 'Service name in docker-compose'
    required: true
  ECR_REGISTRY:
    description: 'ECR registry URL'
    required: true
    default: '211125563966.dkr.ecr.ap-northeast-2.amazonaws.com'
  AWS_REGION:
    description: 'AWS Region'
    required: false
    default: 'ap-northeast-2'
  WORKDIR:
    description: 'Working directory containing docker-compose.yml'
    required: false
    default: '/home/ec2-user/deploy'
  PRUNE:
    description: 'Prune old images'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Deploy using AWS SSM
      shell: bash
      run: |
        # SSM ëª…ë ¹ì–´ ì‹¤í–‰
        COMMAND_ID=$(aws ssm send-command \
          --targets "Key=instanceids,Values=${{ inputs.EC2 }}" \
          --document-name "AWS-RunShellScript" \
          --parameters commands=["cd ${{ inputs.WORKDIR }} && ./deploy.sh ${{ inputs.SERVICE_NAME }} ${{ inputs.ECR_REGISTRY }} ${{ inputs.AWS_REGION }}"] \
          --comment "Deploy ${{ inputs.SERVICE_NAME }}" \
          --output text \
          --query "Command.CommandId")

        echo "ğŸ“ ë°°í¬ ëª…ë ¹ì–´ ì‹¤í–‰ ID: $COMMAND_ID"

        echo "â³ ëª…ë ¹ì–´ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ inputs.EC2 }}"

        # ëª…ë ¹ì–´ ì‹¤í–‰ ìƒíƒœì™€ ì¶œë ¥ ë¡œê·¸ë¥¼ í•¨ê»˜ í™•ì¸
        COMMAND_STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ inputs.EC2 }}" \
          --query "Status" \
          --output text)

        # ìƒíƒœë³„ ë¡œê·¸ ì¶œë ¥ ë° ì²˜ë¦¬
        case "$COMMAND_STATUS" in
          "Success")
            echo "âœ… ë°°í¬ ì„±ê³µ"
            echo "ğŸ“‹ === ë°°í¬ ê²°ê³¼ ë¡œê·¸ ==="
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ inputs.EC2 }}" \
              --query "StandardOutputContent" \
              --output text
            ;;
            
          "InProgress")
            echo "â³ ë°°í¬ ì§„í–‰ ì¤‘"
            echo "ğŸ“‹ === í˜„ì¬ê¹Œì§€ì˜ ì§„í–‰ ë¡œê·¸ ==="
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ inputs.EC2 }}" \
              --query "StandardOutputContent" \
              --output text
            ;;
            
          "Failed")
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            echo "âš ï¸ === ìƒì„¸ ì˜¤ë¥˜ ë¡œê·¸ ==="
            echo "ğŸ” í‘œì¤€ ì—ëŸ¬:"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ inputs.EC2 }}" \
              --query "StandardErrorContent" \
              --output text
            
            echo "ğŸ“‹ í‘œì¤€ ì¶œë ¥:"
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ inputs.EC2 }}" \
              --query "StandardOutputContent" \
              --output text
            exit 1
            ;;
            
          *)
            echo "â“ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: $COMMAND_STATUS"
            exit 1
            ;;
        esac

        if [ "${{ inputs.PRUNE }}" == "true" ]; then
          echo "ğŸ§¹ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."

          COMMAND_ID=$(aws ssm send-command \
            --targets "Key=instanceids,Values=${{ inputs.EC2 }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands=["docker image prune -a -f"] \
            --comment "Prune Docker images from EC2 Instance ${{ inputs.EC2 }}" \
            --output text \
            --query "Command.CommandId")

          echo "ğŸ” ëª…ë ¹ì–´ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ inputs.EC2 }}"

          # ëª…ë ¹ì–´ ì‹¤í–‰ ìƒíƒœì™€ ì¶œë ¥ ë¡œê·¸ë¥¼ í•¨ê»˜ í™•ì¸
          COMMAND_STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ inputs.EC2 }}" \
            --query "Status" \
            --output text)

          # ìƒíƒœë³„ ë¡œê·¸ ì¶œë ¥ ë° ì²˜ë¦¬
          case "$COMMAND_STATUS" in
            "Success")
              echo "âœ… Docker ì´ë¯¸ì§€ ì •ë¦¬ ì„±ê³µ"
              echo "ğŸ“‹ === ì´ë¯¸ì§€ ì •ë¦¬ ê²°ê³¼ ë¡œê·¸ ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ inputs.EC2 }}" \
                --query "StandardOutputContent" \
                --output text
              ;;
              
            "Failed")
              echo "âŒ Docker ì´ë¯¸ì§€ ì •ë¦¬ ì‹¤íŒ¨"
              echo "âš ï¸ === ìƒì„¸ ì˜¤ë¥˜ ë¡œê·¸ ==="
              echo "ğŸ” í‘œì¤€ ì—ëŸ¬:"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ inputs.EC2 }}" \
                --query "StandardErrorContent" \
                --output text
              
              echo "ğŸ“‹ í‘œì¤€ ì¶œë ¥:"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ inputs.EC2 }}" \
                --query "StandardOutputContent" \
                --output text
                
              echo "ğŸ“ ì‘ë‹µ ì½”ë“œ:"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ inputs.EC2 }}" \
                --query "ResponseCode" \
                --output text
              
              exit 1
              ;;
              
            "InProgress")
              echo "ğŸ”„ Docker ì´ë¯¸ì§€ ì •ë¦¬ ì§„í–‰ ì¤‘..."
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ inputs.EC2 }}" \
                --query "StandardOutputContent" \
                --output text
              ;;
              
            *)
              echo "â“ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: $COMMAND_STATUS"
              echo "âš ï¸ === ì˜¤ë¥˜ ìƒì„¸ ì •ë³´ ==="
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ inputs.EC2 }}" \
                --query "{Error:StandardErrorContent,Output:StandardOutputContent,ResponseCode:ResponseCode}" \
                --output json
              exit 1
              ;;
          esac
        fi
